default:
  image: 
    dockerfile: Dockerfile.ci
    cache:
     - $CI_REGISTRY:latest
  
  before_script:
    - whoami
    - apt-get update -qy
    - ansible --version
    - ansible-lint --version
    - mkdir secret
    - echo "$ANSIBLE_SSHKEY" > secret/ansible.key
    - echo ansible_hosts > etc/ansible/hosts
    - cat etc/ansible/hosts
    - chmod 400 secret/ansible.key
    - export ANSIBLE_HOST_KEY_CHECKING=False

stages:
  - verify
  - predeploy
  - deploy

ansible-verify:
  stage: verify
  script:
    - ansible-lint -v *.yml
    - ansilble-playbook --inventory inventory/master --syntax-check *.yml
  rules:
    - if: '$CI_BUILD_BEFORE_SHA == "0000000000000000000000000000000000000000"'
      when: always
    - if: '$CI_COMMIT_BRANCH != "master"'
      when: always

predeploy:
  stage: predeploy
  script:
    - ansible --private-key secret/ansible.key --user ansible all -m ping
  rules:
    - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "master"'
      when: always

deploy:
  stage: deploy
  script:
    - ./cicd-info.sh > roles/common/files/cicd-info.txt # Run script to get GitLab CI env vars. Ansible will copy then to hosts.
    - ansible-playbook --private-key secret/ansible.key --user ansible playbook.yml
  rules:
    - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "master"'
      when: always
